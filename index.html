<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QWERTY - Typing Speed Test</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&family=Pixelify+Sans:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      defer
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Rubik", "ui-sans-serif", "system-ui"],
              pixel: ["Pixelify Sans", "monospace"],
            },
            colors: {
              "nord-0": "#2e3440",
              "nord-1": "#3b4252",
              "nord-2": "#434c5e",
              "nord-3": "#4c566a",
              "nord-4": "#d8dee9",
              "nord-5": "#e5e9f0",
              "nord-6": "#eceff4",
              "nord-7": "#8fbcbb",
              "nord-8": "#88c0d0",
              "nord-9": "#81a1c1",
              "nord-10": "#5e81ac",
              "nord-11": "#bf616a",
              "nord-12": "#d08770",
              "nord-13": "#ebcb8b",
              "nord-14": "#a3be8c",
              "nord-15": "#b48ead",
            },
            animation: {
              "pulse-slow": "pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite",
              "bounce-slow": "bounce 2s infinite",
              "fade-in": "fadeIn 0.5s ease-in-out",
              "slide-up": "slideUp 0.3s ease-out",
              wiggle: "wiggle 0.5s ease-in-out",
              "key-press": "keyPress 0.15s ease-in-out",
              "key-glow": "keyGlow 0.3s ease-in-out",
              "cursor-blink": "cursorBlink 1s infinite",
            },
            keyframes: {
              fadeIn: {
                "0%": { opacity: "0", transform: "translateY(10px)" },
                "100%": { opacity: "1", transform: "translateY(0)" },
              },
              slideUp: {
                "0%": { transform: "translateY(20px)", opacity: "0" },
                "100%": { transform: "translateY(0)", opacity: "1" },
              },
              wiggle: {
                "0%, 100%": { transform: "rotate(-3deg)" },
                "50%": { transform: "rotate(3deg)" },
              },
              keyPress: {
                "0%": { transform: "scale(1)" },
                "50%": { transform: "scale(0.95)" },
                "100%": { transform: "scale(1)" },
              },
              keyGlow: {
                "0%": { boxShadow: "0 0 0 rgba(129, 161, 193, 0)" },
                "50%": { boxShadow: "0 0 20px rgba(129, 161, 193, 0.6)" },
                "100%": { boxShadow: "0 0 0 rgba(129, 161, 193, 0)" },
              },
              cursorBlink: {
                "0%, 50%": { borderRight: "2px solid currentColor" },
                "51%, 100%": { borderRight: "2px solid transparent" },
              },
            },
          },
        },
      };
    </script>
  </head>
  <body class="min-h-screen">
    <div
      x-data="typingTest()"
      :class="isDarkMode ? 'bg-gradient-to-br from-nord-0 via-nord-1 to-nord-2' : 'bg-gradient-to-br from-nord-6 via-nord-5 to-nord-4'"
      class="min-h-screen transition-all duration-500 px-4 py-8"
    >
      <div class="text-center mb-8 animate-fade-in max-w-7xl mx-auto" x-show="!focusMode">
        <h1 class="text-6xl font-pixel font-black mb-4 flex justify-center space-x-2 transform hover:scale-105 transition-transform duration-300">
          <span 
            :class="isDarkMode ? 'bg-nord-3 text-nord-6 border-nord-2 shadow-nord-0/50' : 'bg-nord-5 text-nord-0 border-nord-4 shadow-nord-1/50'"
            class="keycap border-2 rounded-lg w-16 h-16 flex items-center justify-center shadow-lg transform hover:translate-y-0.5 transition-transform duration-150"
          >Q</span>
          <span 
            :class="isDarkMode ? 'bg-nord-3 text-nord-6 border-nord-2 shadow-nord-0/50' : 'bg-nord-5 text-nord-0 border-nord-4 shadow-nord-1/50'"
            class="keycap border-2 rounded-lg w-16 h-16 flex items-center justify-center shadow-lg transform hover:translate-y-0.5 transition-transform duration-150"
          >W</span>
          <span 
            :class="isDarkMode ? 'bg-nord-3 text-nord-6 border-nord-2 shadow-nord-0/50' : 'bg-nord-5 text-nord-0 border-nord-4 shadow-nord-1/50'"
            class="keycap border-2 rounded-lg w-16 h-16 flex items-center justify-center shadow-lg transform hover:translate-y-0.5 transition-transform duration-150"
          >E</span>
          <span 
            :class="isDarkMode ? 'bg-nord-3 text-nord-6 border-nord-2 shadow-nord-0/50' : 'bg-nord-5 text-nord-0 border-nord-4 shadow-nord-1/50'"
            class="keycap border-2 rounded-lg w-16 h-16 flex items-center justify-center shadow-lg transform hover:translate-y-0.5 transition-transform duration-150"
          >R</span>
          <span 
            :class="isDarkMode ? 'bg-nord-3 text-nord-6 border-nord-2 shadow-nord-0/50' : 'bg-nord-5 text-nord-0 border-nord-4 shadow-nord-1/50'"
            class="keycap border-2 rounded-lg w-16 h-16 flex items-center justify-center shadow-lg transform hover:translate-y-0.5 transition-transform duration-150"
          >T</span>
          <span 
            :class="isDarkMode ? 'bg-nord-3 text-nord-6 border-nord-2 shadow-nord-0/50' : 'bg-nord-5 text-nord-0 border-nord-4 shadow-nord-1/50'"
            class="keycap border-2 rounded-lg w-16 h-16 flex items-center justify-center shadow-lg transform hover:translate-y-0.5 transition-transform duration-150"
          >Y</span>
        </h1>
        <p :class="isDarkMode ? 'text-nord-4' : 'text-nord-1'" class="text-lg font-pixel tracking-wide">
          Test your typing speed and accuracy!
        </p>
      </div>

      <div class="flex flex-wrap justify-center gap-4 mb-10 max-w-7xl mx-auto px-4" x-show="!focusMode">
        <div
          class="bg-nord-11 border-nord-11 rounded-xl p-3 border flex items-center space-x-3"
        >
          <span
            class="text-white text-sm font-medium whitespace-nowrap"
            >Time:</span
          >
          <div class="flex space-x-1">
            <template x-for="time in timeOptions" :key="time">
              <button
                @click="setTimeLimit(time)"
                :class="timeLimit === time ? 
                  'bg-white text-nord-11' : 
                  'bg-transparent text-white hover:bg-white/20'"
                class="px-3 py-1.5 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105 text-sm"
                :disabled="isActive"
                x-text="time + 's'"
              ></button>
            </template>
          </div>
        </div>

        <div
          class="bg-nord-12 border-nord-12 rounded-xl p-3 border flex items-center space-x-3"
        >
          <span
            class="text-white text-sm font-medium whitespace-nowrap"
            >Mode:</span
          >
          <div class="flex space-x-1">
            <template x-for="mode in modeOptions" :key="mode.id">
              <button
                @click="setMode(mode.id)"
                :class="currentMode === mode.id ? 
                  'bg-white text-nord-12' : 
                  'bg-transparent text-white hover:bg-white/20'"
                class="px-3 py-1.5 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105 text-sm"
                :disabled="isActive"
                x-text="mode.name"
              ></button>
            </template>
          </div>
        </div>

        <div
          class="bg-nord-13 border-nord-13 rounded-xl p-3 border flex items-center space-x-3"
        >
          <span
            class="text-nord-0 text-sm font-medium whitespace-nowrap"
            >Difficulty:</span
          >
          <div class="flex space-x-1">
            <template x-for="difficulty in difficultyOptions" :key="difficulty.id">
              <button
                @click="setDifficulty(difficulty.id)"
                :class="currentDifficulty === difficulty.id ? 
                  'bg-nord-0 text-nord-13' : 
                  'bg-transparent text-nord-0 hover:bg-nord-0/20'"
                class="px-3 py-1.5 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105 text-sm"
                :disabled="isActive"
                x-text="difficulty.name"
              ></button>
            </template>
          </div>
        </div>

        <div
          class="bg-nord-14 border-nord-14 rounded-full w-16 h-16 border flex items-center justify-center"
        >
          <button
            @click="toggleTheme"
            class="bg-nord-0 text-nord-14 hover:bg-nord-0/80 p-2 rounded-full transition-all duration-300 transform hover:scale-105"
            :title="isDarkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode'"
          >
            <svg
              x-show="isDarkMode"
              class="w-4 h-4"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
                clip-rule="evenodd"
              ></path>
            </svg>
            <svg
              x-show="!isDarkMode"
              class="w-4 h-4"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
              ></path>
            </svg>
          </button>
        </div>
      </div>

      <div
        class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-10 max-w-3xl mx-auto px-4"
        x-show="!focusMode"
      >
        <div
          :class="isDarkMode ? 'bg-nord-1/90 border-nord-3/50 hover:bg-nord-1' : 'bg-nord-6/90 border-nord-4/50 hover:bg-nord-6'"
          class="backdrop-blur-lg rounded-lg p-2 text-center border transition-all duration-300"
        >
          <div
            :class="isDarkMode ? 'text-nord-14' : 'text-nord-14'"
            class="text-lg font-bold"
            x-text="wpm"
          ></div>
          <div
            :class="isDarkMode ? 'text-nord-5' : 'text-nord-1'"
            class="text-xs font-medium"
          >
            WPM
          </div>
        </div>
        <div
          :class="isDarkMode ? 'bg-nord-1/90 border-nord-3/50 hover:bg-nord-1' : 'bg-nord-6/90 border-nord-4/50 hover:bg-nord-6'"
          class="backdrop-blur-lg rounded-lg p-2 text-center border transition-all duration-300"
        >
          <div
            :class="isDarkMode ? 'text-nord-8' : 'text-nord-8'"
            class="text-lg font-bold"
            x-text="accuracy + '%'"
          ></div>
          <div
            :class="isDarkMode ? 'text-nord-5' : 'text-nord-1'"
            class="text-xs font-medium"
          >
            Accuracy
          </div>
        </div>
        <div
          :class="isDarkMode ? 'bg-nord-1/90 border-nord-3/50 hover:bg-nord-1' : 'bg-nord-6/90 border-nord-4/50 hover:bg-nord-6'"
          class="backdrop-blur-lg rounded-lg p-2 text-center border transition-all duration-300"
        >
          <div
            :class="isDarkMode ? 'text-nord-13' : 'text-nord-13'"
            class="text-lg font-bold"
            x-text="timeLeft"
          ></div>
          <div
            :class="isDarkMode ? 'text-nord-5' : 'text-nord-1'"
            class="text-xs font-medium"
          >
            Time Left
          </div>
        </div>
        <div
          :class="isDarkMode ? 'bg-nord-1/90 border-nord-3/50 hover:bg-nord-1' : 'bg-nord-6/90 border-nord-4/50 hover:bg-nord-6'"
          class="backdrop-blur-lg rounded-lg p-2 text-center border transition-all duration-300"
        >
          <div
            :class="isDarkMode ? 'text-nord-11' : 'text-nord-11'"
            class="text-lg font-bold"
            x-text="errors"
          ></div>
          <div
            :class="isDarkMode ? 'text-nord-5' : 'text-nord-1'"
            class="text-xs font-medium"
          >
            Errors
          </div>
        </div>
      </div>

      <div
        :class="isDarkMode ? 'bg-nord-1/90 border-nord-3/50' : 'bg-nord-6/90 border-nord-4/50'"
        class="backdrop-blur-lg rounded-xl p-6 sm:p-8 lg:p-10 mb-10 border max-w-6xl mx-auto shadow-2xl"
      >
        <div
          :class="isDarkMode ? 'text-nord-6' : 'text-nord-0'"
          class="text-xl font-mono select-none overflow-hidden relative"
          style="height: 4.5em; line-height: 1.5em; width: 100%;"
          id="textDisplay"
        >
          <div 
            class="transition-transform duration-300 ease-out"
            :style="'transform: translateY(' + scrollOffset + 'em)'"
            style="word-wrap: break-word; white-space: normal;"
          >
            <template x-for="(char, index) in textToType.split('')" :key="index">
              <span
                :class="getCharClass(index)"
                class="transition-colors duration-150"
                x-text="char"
                :style="char === ' ' ? 'margin-right: 0.25em;' : ''"
              ></span>
            </template>
          </div>
        </div>
      </div>

      <input
        x-ref="hiddenInput"
        x-model="userInput"
        @input="handleInput"
        @keydown="handleKeydown"
        @blur="refocusInput"
        :disabled="!isActive && timeLeft === 0"
        class="sr-only"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="off"
        spellcheck="false"
      />

      <div class="mb-12 max-w-2xl mx-auto px-4" x-show="!focusMode">
        <div class="space-y-1">
          <div class="flex justify-center space-x-0.5">
            <template x-for="key in keyboardLayout.numbers" :key="key">
              <div
                :class="pressedKeys.includes(key) ? 
                  (isDarkMode ? 'bg-nord-8 text-nord-0 animate-key-press animate-key-glow shadow-lg' : 'bg-nord-8 text-nord-6 animate-key-press animate-key-glow shadow-lg') : 
                  (isDarkMode ? 'bg-nord-3 text-nord-6 hover:bg-nord-2' : 'bg-nord-5 text-nord-0 hover:bg-nord-4 border-nord-4')"
                class="w-5 h-5 sm:w-6 sm:h-6 flex items-center justify-center rounded border text-xs font-mono transition-all duration-150 shadow-sm"
                x-text="key"
              ></div>
            </template>
          </div>

          <div class="flex justify-center space-x-0.5">
            <template x-for="key in keyboardLayout.topRow" :key="key">
              <div
                :class="pressedKeys.includes(key.toLowerCase()) ? 
                  (isDarkMode ? 'bg-nord-8 text-nord-0 animate-key-press animate-key-glow shadow-lg' : 'bg-nord-8 text-nord-6 animate-key-press animate-key-glow shadow-lg') : 
                  (isDarkMode ? 'bg-nord-3 text-nord-6 hover:bg-nord-2' : 'bg-nord-5 text-nord-0 hover:bg-nord-4 border-nord-4')"
                class="w-5 h-5 sm:w-6 sm:h-6 flex items-center justify-center rounded border text-xs font-mono transition-all duration-150 shadow-sm"
                x-text="key"
              ></div>
            </template>
          </div>

          <div class="flex justify-center space-x-0.5">
            <template x-for="key in keyboardLayout.middleRow" :key="key">
              <div
                :class="pressedKeys.includes(key.toLowerCase()) ? 
                  (isDarkMode ? 'bg-nord-8 text-nord-0 animate-key-press animate-key-glow shadow-lg' : 'bg-nord-8 text-nord-6 animate-key-press animate-key-glow shadow-lg') : 
                  (isDarkMode ? 'bg-nord-3 text-nord-6 hover:bg-nord-2' : 'bg-nord-5 text-nord-0 hover:bg-nord-4 border-nord-4')"
                class="w-5 h-5 sm:w-6 sm:h-6 flex items-center justify-center rounded border text-xs font-mono transition-all duration-150 shadow-sm"
                x-text="key"
              ></div>
            </template>
          </div>

          <div class="flex justify-center space-x-0.5">
            <template x-for="key in keyboardLayout.bottomRow" :key="key">
              <div
                :class="pressedKeys.includes(key.toLowerCase()) ? 
                  (isDarkMode ? 'bg-nord-8 text-nord-0 animate-key-press animate-key-glow shadow-lg' : 'bg-nord-8 text-nord-6 animate-key-press animate-key-glow shadow-lg') : 
                  (isDarkMode ? 'bg-nord-3 text-nord-6 hover:bg-nord-2' : 'bg-nord-5 text-nord-0 hover:bg-nord-4 border-nord-4')"
                class="w-6 h-6 sm:w-7 sm:h-7 flex items-center justify-center rounded border text-xs font-mono transition-all duration-150 shadow-sm"
                x-text="key"
              ></div>
            </template>
          </div>

          <div class="flex justify-center">
            <div
              :class="pressedKeys.includes(' ') ? 
                (isDarkMode ? 'bg-nord-8 text-nord-0 animate-key-press animate-key-glow shadow-lg' : 'bg-nord-8 text-nord-6 animate-key-press animate-key-glow shadow-lg') : 
                (isDarkMode ? 'bg-nord-3 text-nord-6 hover:bg-nord-2' : 'bg-nord-5 text-nord-0 hover:bg-nord-4 border-nord-4')"
              class="w-32 sm:w-40 h-6 sm:h-7 flex items-center justify-center rounded border text-xs font-mono transition-all duration-150 shadow-sm"
            >
              SPACE
            </div>
          </div>
        </div>
      </div>

      <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-6 mb-12 max-w-7xl mx-auto px-4" x-show="!focusMode">
        <button
          @click="startTest"
          :disabled="isActive"
          :class="isDarkMode ? 
            'bg-gradient-to-r from-nord-14 to-nord-14 text-nord-0 hover:from-nord-14/80 hover:to-nord-14/80' : 
            'bg-gradient-to-r from-nord-14 to-nord-14 text-nord-6 hover:from-nord-14/80 hover:to-nord-14/80'"
          class="px-6 sm:px-8 lg:px-10 py-3 sm:py-4 font-semibold rounded-xl disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 transform hover:scale-105 active:scale-95 w-full sm:w-auto"
          :class="{ 'animate-bounce-slow': !isActive && timeLeft === timeLimit }"
        >
          <span x-show="!isActive && timeLeft === timeLimit">Start Test</span>
          <span x-show="isActive">Test Running...</span>
          <span x-show="!isActive && timeLeft === 0">Test Complete</span>
        </button>

        <button
          @click="resetTest"
          :class="isDarkMode ? 
            'bg-gradient-to-r from-nord-3 to-nord-3 text-nord-6 hover:from-nord-3/80 hover:to-nord-3/80' : 
            'bg-gradient-to-r from-nord-3 to-nord-3 text-nord-6 hover:from-nord-3/80 hover:to-nord-3/80'"
          class="px-6 sm:px-8 lg:px-10 py-3 sm:py-4 font-semibold rounded-xl transition-all duration-300 transform hover:scale-105 active:scale-95 w-full sm:w-auto"
        >
          Reset
        </button>
      </div>

      <div
        x-show="showResults"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 scale-90"
        x-transition:enter-end="opacity-100 scale-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 scale-100"
        x-transition:leave-end="opacity-0 scale-90"
        class="fixed inset-0 bg-nord-0/80 backdrop-blur-sm flex items-center justify-center z-50"
        style="display: none"
      >
        <div
          :class="isDarkMode ? 'bg-nord-1/95 border-nord-3/50' : 'bg-nord-6/95 border-nord-4/50'"
          class="backdrop-blur-lg border rounded-2xl p-8 max-w-md w-full mx-4 animate-slide-up"
        >
          <div class="text-center">
            <h2
              :class="isDarkMode ? 'text-nord-6' : 'text-nord-0'"
              class="text-3xl font-bold mb-6"
            >
              Test Complete!
            </h2>

            <div class="space-y-4 mb-6">
              <div class="flex justify-between items-center">
                <span
                  :class="isDarkMode ? 'text-nord-5' : 'text-nord-1'"
                  class="font-medium"
                  >Words Per Minute:</span
                >
                <span
                  :class="isDarkMode ? 'text-nord-14' : 'text-nord-14'"
                  class="text-2xl font-bold"
                  x-text="finalWpm"
                ></span>
              </div>
              <div class="flex justify-between items-center">
                <span
                  :class="isDarkMode ? 'text-nord-5' : 'text-nord-1'"
                  class="font-medium"
                  >Accuracy:</span
                >
                <span
                  :class="isDarkMode ? 'text-nord-8' : 'text-nord-8'"
                  class="text-2xl font-bold"
                  x-text="finalAccuracy + '%'"
                ></span>
              </div>
              <div class="flex justify-between items-center">
                <span
                  :class="isDarkMode ? 'text-nord-5' : 'text-nord-1'"
                  class="font-medium"
                  >Total Characters:</span
                >
                <span
                  :class="isDarkMode ? 'text-nord-13' : 'text-nord-13'"
                  class="text-xl font-bold"
                  x-text="totalChars"
                ></span>
              </div>
              <div class="flex justify-between items-center">
                <span
                  :class="isDarkMode ? 'text-nord-5' : 'text-nord-1'"
                  class="font-medium"
                  >Errors:</span
                >
                <span
                  :class="isDarkMode ? 'text-nord-11' : 'text-nord-11'"
                  class="text-xl font-bold"
                  x-text="finalErrors"
                ></span>
              </div>
            </div>

            <div class="text-center mb-6">
              <div
                :class="isDarkMode ? 'text-nord-5' : 'text-nord-1'"
                class="text-lg"
                x-text="getPerformanceMessage()"
              ></div>
            </div>

            <button
              @click="closeResults"
              :class="isDarkMode ? 
                'bg-gradient-to-r from-nord-15 to-nord-15 text-nord-6 hover:from-nord-15/80 hover:to-nord-15/80' : 
                'bg-gradient-to-r from-nord-15 to-nord-15 text-nord-6 hover:from-nord-15/80 hover:to-nord-15/80'"
              class="w-full px-6 py-3 font-semibold rounded-xl transition-all duration-300 transform hover:scale-105"
            >
              Try Again
            </button>
          </div>
        </div>
      </div>

      <div
        x-show="showEscMenu"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed inset-0 bg-nord-0/80 backdrop-blur-sm flex items-center justify-center z-50"
        style="display: none"
        @click="showEscMenu = false"
      >
        <div
          :class="isDarkMode ? 'bg-nord-1/95 border-nord-3/50' : 'bg-nord-6/95 border-nord-4/50'"
          class="backdrop-blur-lg border rounded-2xl p-8 max-w-md w-full mx-4"
          x-transition:enter="transition ease-out duration-300 transform"
          x-transition:enter-start="opacity-0 scale-90 translate-y-4"
          x-transition:enter-end="opacity-100 scale-100 translate-y-0"
          x-transition:leave="transition ease-in duration-200 transform"
          x-transition:leave-start="opacity-100 scale-100 translate-y-0"
          x-transition:leave-end="opacity-0 scale-90 translate-y-4"
          @click.stop
        >
          <div class="text-center">
            <h2
              :class="isDarkMode ? 'text-nord-6' : 'text-nord-0'"
              class="text-2xl font-pixel font-bold mb-6"
            >
              Menu
            </h2>

            <div class="space-y-4">
              <!-- Statistics -->
              <div 
                :class="isDarkMode ? 'bg-nord-2/50 text-nord-5' : 'bg-nord-4/50 text-nord-1'"
                class="p-4 rounded-lg text-sm"
              >
                <div class="font-semibold mb-2">Session Stats:</div>
                <div class="grid grid-cols-2 gap-2 text-xs">
                  <div>Tests completed: <span class="font-bold" x-text="sessionStats.testsCompleted"></span></div>
                  <div>Best WPM: <span class="font-bold" x-text="sessionStats.bestWpm"></span></div>
                  <div>Avg accuracy: <span class="font-bold" x-text="sessionStats.totalAccuracy + '%'"></span></div>
                  <div>Time practiced: <span class="font-bold" x-text="sessionStats.timePracticed + 'm'"></span></div>
                </div>
              </div>

              <!-- Focus Mode -->
              <button
                @click="toggleFocusMode(); showEscMenu = false"
                :class="isDarkMode ? 
                  'bg-nord-15 text-white hover:bg-nord-15/80' : 
                  'bg-nord-15 text-white hover:bg-nord-15/80'"
                class="w-full px-6 py-3 font-semibold rounded-xl transition-all duration-300 transform hover:scale-105"
              >
                <span x-text="focusMode ? 'Exit' : 'Enter'"></span> Focus Mode
              </button>

              <!-- Export Results -->
              <button
                @click="exportResults(); showEscMenu = false"
                :class="isDarkMode ? 
                  'bg-nord-14 text-white hover:bg-nord-14/80' : 
                  'bg-nord-14 text-white hover:bg-nord-14/80'"
                class="w-full px-6 py-3 font-semibold rounded-xl transition-all duration-300 transform hover:scale-105"
              >
                Export Test Results
              </button>

              <!-- Reset Statistics -->
              <button
                @click="resetStats(); showEscMenu = false"
                :class="isDarkMode ? 
                  'bg-nord-11 text-white hover:bg-nord-11/80' : 
                  'bg-nord-11 text-white hover:bg-nord-11/80'"
                class="w-full px-6 py-3 font-semibold rounded-xl transition-all duration-300 transform hover:scale-105"
              >
                Reset All Statistics
              </button>

              <!-- Keyboard Shortcuts Info -->
              <div 
                :class="isDarkMode ? 'bg-nord-2/50 text-nord-5' : 'bg-nord-4/50 text-nord-1'"
                class="p-4 rounded-lg text-sm"
              >
                <div class="font-semibold mb-2">Keyboard Shortcuts:</div>
                <div class="flex flex-wrap gap-2 text-xs justify-center">
                  <div class="flex items-center gap-1">
                    <kbd class="px-1 py-0.5 bg-nord-3 text-nord-6 rounded text-xs">ESC</kbd>
                    <span>Menu</span>
                  </div>
                  <div class="flex items-center gap-1">
                    <kbd class="px-1 py-0.5 bg-nord-3 text-nord-6 rounded text-xs">Ctrl+R</kbd>
                    <span>Reset</span>
                  </div>
                  <div class="flex items-center gap-1">
                    <kbd class="px-1 py-0.5 bg-nord-3 text-nord-6 rounded text-xs">Ctrl+M</kbd>
                    <span>Theme</span>
                  </div>
                </div>
              </div>

              <!-- Close Button -->
              <button
                @click="showEscMenu = false"
                :class="isDarkMode ? 
                  'bg-nord-3 text-nord-6 hover:bg-nord-2' : 
                  'bg-nord-4 text-nord-0 hover:bg-nord-3'"
                class="w-full px-6 py-3 font-semibold rounded-xl transition-all duration-300"
              >
                Close Menu
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="text-center text-sm max-w-7xl mx-auto" x-show="!focusMode">
        <p :class="isDarkMode ? 'text-nord-4' : 'text-nord-2'">
          Tip: Focus on accuracy first, speed will come naturally!
        </p>
      </div>
    </div>

    <script>
      function typingTest() {
        return {
          textToType:
            "The quick brown fox jumps over the lazy dog. This pangram contains every letter of the alphabet at least once. It's commonly used for typing practice because it helps improve finger dexterity and familiarity with all keyboard letters. Regular practice with varied texts like this can significantly improve your typing speed and accuracy over time.",
          userInput: "",
          isActive: false,
          timeLeft: 60,
          timeLimit: 60,
          timeOptions: [15, 30, 60],
          startTime: null,
          timer: null,
          wpm: 0,
          accuracy: 100,
          errors: 0,
          showResults: false,
          finalWpm: 0,
          finalAccuracy: 100,
          finalErrors: 0,
          totalChars: 0,
          pressedKeys: [],
          isDarkMode: true, // Default to dark mode
          currentMode: "sentences",
          modeOptions: [
            { id: "words", name: "Words" },
            { id: "sentences", name: "Sentences" },
            { id: "numbers", name: "Numbers" },
          ],
          currentDifficulty: "medium",
          difficultyOptions: [
            { id: "easy", name: "Easy" },
            { id: "medium", name: "Medium" },
            { id: "hard", name: "Hard" },
          ],
          wordsData: [],
          sentencesData: [],
          numbersData: [],
          scrollOffset: 0,
          showEscMenu: false,
          focusMode: false,
          sessionStats: {
            testsCompleted: 0,
            bestWpm: 0,
            totalAccuracy: 0,
            timePracticed: 0
          },
          keyboardLayout: {
            numbers: ["1", "2", "3", "4", "5", "6", "7", "8", "9", "0"],
            topRow: ["Q", "W", "E", "R", "T", "Y", "U", "I", "O", "P"],
            middleRow: ["A", "S", "D", "F", "G", "H", "J", "K", "L"],
            bottomRow: ["Z", "X", "C", "V", "B", "N", "M"],
          },

          async init() {
            await this.loadAllData();
            this.generateNewText();
            // Load theme preference from localStorage
            const savedTheme = localStorage.getItem("qwerty-theme");
            if (savedTheme !== null) {
              this.isDarkMode = savedTheme === "dark";
            }
            // Load saved statistics
            this.loadStats();
            // Apply initial theme to body
            this.updateBodyTheme();
            // Auto-focus the hidden input
            this.$nextTick(() => {
              this.$refs.hiddenInput.focus();
            });
          },

          async loadAllData() {
            try {
  
              const [wordsResponse, sentencesResponse, numbersResponse] = await Promise.all([
                fetch('words.json'),
                fetch('sentences.json'),
                fetch('numbers.json')
              ]);

              const wordsData = await wordsResponse.json();
              const sentencesData = await sentencesResponse.json();
              const numbersData = await numbersResponse.json();

              this.wordsData = wordsData.words;
              this.sentencesData = sentencesData.sentences;
              this.numbersData = numbersData.numberedTexts;
            } catch (error) {
              console.error('Error loading data files:', error);
              this.textToType = "The quick brown fox jumps over the lazy dog. This pangram contains every letter of the alphabet at least once.";
            }
          },

          updateBodyTheme() {},

          toggleTheme() {
            this.isDarkMode = !this.isDarkMode;
            // Save theme preference to localStorage
            localStorage.setItem(
              "qwerty-theme",
              this.isDarkMode ? "dark" : "light"
            );
            // Update body theme immediately
            this.updateBodyTheme();
          },

          refocusInput() {
            // Keep input focused for seamless typing
            setTimeout(() => {
              if (this.$refs.hiddenInput) {
                this.$refs.hiddenInput.focus();
              }
            }, 10);
          },

          generateNewText() {
            // Generate smaller initial text for faster loading
            this.textToType = this.generateContinuousText(200); // Start with 200 words/characters worth
            this.scrollOffset = 0;
          },

          generateContinuousText(targetLength) {
            let generatedText = "";
            
            if (this.currentMode === "words") {
              generatedText = this.generateWordsText(targetLength);
            } else if (this.currentMode === "sentences") {
              generatedText = this.generateSentencesText(targetLength);
            } else if (this.currentMode === "numbers") {
              generatedText = this.generateNumbersText(targetLength);
            }
            
            return generatedText || "The quick brown fox jumps over the lazy dog. This pangram contains every letter of the alphabet at least once.";
          },

          generateWordsText(wordCount) {
            if (this.wordsData.length === 0) return "";
            
            const selectedWords = [];
            const commonWords = this.wordsData[0] || [];
            const programmingWords = this.wordsData[1] || [];
            const challengingWords = this.wordsData[2] || [];
            
            let wordPool = [];
            
            // Select word pool based on difficulty
            if (this.currentDifficulty === "easy") {
              wordPool = commonWords;
            } else if (this.currentDifficulty === "medium") {
              wordPool = [...commonWords, ...programmingWords];
            } else if (this.currentDifficulty === "hard") {
              wordPool = [...commonWords, ...programmingWords, ...challengingWords, ...challengingWords];
            }
            
            if (wordPool.length === 0) {
              wordPool = this.wordsData.flat();
            }
            
            for (let i = 0; i < wordCount; i++) {
              if (wordPool.length > 0) {
                const randomWord = wordPool[Math.floor(Math.random() * wordPool.length)];
                if (randomWord && randomWord.length > 0) {
                  selectedWords.push(randomWord);
                }
              }
            }
            
            return selectedWords.join(" ");
          },

          generateSentencesText(targetLength) {
            if (this.sentencesData.length === 0) return "";
            
            let text = "";
            let attempts = 0;
            
            while (text.length < targetLength && attempts < 20) {
              if (text.length > 0) text += " ";
              
              let selectedSentence = this.sentencesData[Math.floor(Math.random() * this.sentencesData.length)];
              
              // Adjust based on difficulty
              if (this.currentDifficulty === "easy") {
                const firstSentence = selectedSentence.split('.')[0] + '.';
                selectedSentence = firstSentence.length > 150 ? selectedSentence.substring(0, 150) + '.' : firstSentence;
              }
              
              text += selectedSentence;
              attempts++;
            }
            
            return text;
          },

          generateNumbersText(targetLength) {
            if (this.numbersData.length === 0) return "";
            
            let text = "";
            let attempts = 0;
            
            while (text.length < targetLength && attempts < 10) {
              if (text.length > 0) text += " ";
              
              let selectedText = this.numbersData[Math.floor(Math.random() * this.numbersData.length)];
              
              if (this.currentDifficulty === "easy") {
                selectedText = selectedText.substring(0, 200);
              }
              
              text += selectedText;
              attempts++;
            }
            
            return text;
          },

          extendText() {
            // Add smaller chunks more frequently for better performance
            const additionalText = this.generateContinuousText(100);
            this.textToType += " " + additionalText;
          },

          getCharClass(index) {
            const isDark = this.isDarkMode;
            
            if (index < this.userInput.length) {
              // Character has been typed
              const typedChar = this.userInput.charAt(index);
              const expectedChar = this.textToType.charAt(index);
              
              if (typedChar === expectedChar) {
                // Correct character - green text
                return 'text-nord-14 px-0.5';
              } else {
                // Incorrect character - red text with wiggle
                return 'text-nord-11 animate-wiggle px-0.5';
              }
            } else if (index === this.userInput.length && this.isActive) {
              // Current cursor position - add blinking cursor
              return isDark ? 'text-nord-9 relative px-0.5 animate-cursor-blink' : 'text-nord-10 relative px-0.5 animate-cursor-blink';
            } else {
              // Untyped character - muted text
              return isDark ? 'text-nord-4 px-0.5' : 'text-nord-3 px-0.5';
            }
          },

          updateScrolling() {
            // Simplified scrolling calculation for better performance
            const charsPerLine = 65; // Fixed estimate for better performance
            const currentLine = Math.floor(this.userInput.length / charsPerLine);
            
            // Start scrolling when we reach the second line
            this.scrollOffset = currentLine >= 1 ? -(currentLine - 1) * 1.5 : 0;
          },

          setMode(mode) {
            if (!this.isActive) {
              this.currentMode = mode;
              this.generateNewText();
            }
          },

          setDifficulty(difficulty) {
            if (!this.isActive) {
              this.currentDifficulty = difficulty;
              this.generateNewText();
            }
          },

          setTimeLimit(time) {
            if (!this.isActive) {
              this.timeLimit = time;
              this.timeLeft = time;
            }
          },

          startTest() {
            this.isActive = true;
            this.startTime = Date.now();
            // Don't clear userInput if it already has content (auto-start scenario)
            if (this.userInput.length === 0) {
              this.userInput = "";
            }
            this.errors = 0;
            this.timeLeft = this.timeLimit;

            this.timer = setInterval(() => {
              this.timeLeft--;
              this.calculateStats();

              if (this.timeLeft <= 0) {
                this.endTest();
              }
            }, 1000);
          },

          endTest() {
            this.isActive = false;
            clearInterval(this.timer);
            this.finalWpm = this.wpm;
            this.finalAccuracy = this.accuracy;
            this.finalErrors = this.errors;
            this.totalChars = this.userInput.length;
            
            // Update statistics
            this.updateStats();
            
            this.showResults = true;
          },

          resetTest() {
            this.isActive = false;
            this.userInput = "";
            this.timeLeft = this.timeLimit;
            this.wpm = 0;
            this.accuracy = 100;
            this.errors = 0;
            this.showResults = false;
            this.pressedKeys = [];
            this.scrollOffset = 0;
            clearInterval(this.timer);
            this.generateNewText();
            // Refocus input after reset
            this.$nextTick(() => {
              this.$refs.hiddenInput.focus();
            });
          },

          handleInput(event) {
            // Auto-start test when user starts typing
            if (!this.isActive && this.userInput.length > 0) {
              // Store the current input before starting test
              const currentInput = this.userInput;
              this.startTest();
              // Restore the input after starting
              this.userInput = currentInput;
            }
            
            this.calculateStats();
            this.updateScrolling();
            
            // Check if user is approaching the end of text and generate more
            if (this.isActive && this.userInput.length >= this.textToType.length - 50) {
              this.extendText();
            }
          },

          handleKeydown(event) {
            // Handle ESC key for menu
            if (event.key === "Escape") {
              event.preventDefault();
              this.showEscMenu = !this.showEscMenu;
              return;
            }

            // Handle Ctrl+R for reset
            if (event.ctrlKey && event.key === "r") {
              event.preventDefault();
              this.resetTest();
              return;
            }

            // Handle Ctrl+M for theme toggle
            if (event.ctrlKey && event.key === "m") {
              event.preventDefault();
              this.toggleTheme();
              return;
            }

            // Close ESC menu if open and any other key is pressed
            if (this.showEscMenu) {
              this.showEscMenu = false;
            }


            // Add visual feedback for key presses
            this.animateKeyPress(event.key);
          },

          animateKeyPress(key) {
            // Handle special keys
            let keyToAnimate = key;
            if (key === " ") {
              keyToAnimate = " "; // Space
            } else if (key.length === 1) {
              keyToAnimate = key.toLowerCase();
            }

            // Add to pressed keys for visual feedback
            if (!this.pressedKeys.includes(keyToAnimate)) {
              this.pressedKeys.push(keyToAnimate);
            }

            // Remove after animation duration
            setTimeout(() => {
              const index = this.pressedKeys.indexOf(keyToAnimate);
              if (index > -1) {
                this.pressedKeys.splice(index, 1);
              }
            }, 300);
          },

          calculateStats() {
            if (!this.userInput.length) {
              this.wpm = 0;
              this.accuracy = 100;
              this.errors = 0;
              return;
            }

            // Calculate WPM (assuming average word length of 5 characters)
            const timeElapsed = (this.timeLimit - this.timeLeft) / 60; // in minutes
            const wordsTyped = this.userInput.length / 5;
            this.wpm =
              timeElapsed > 0 ? Math.round(wordsTyped / timeElapsed) : 0;

            // Calculate accuracy and errors
            let correctChars = 0;
            let errorCount = 0;

            for (let i = 0; i < this.userInput.length; i++) {
              if (i < this.textToType.length) {
                // Use charAt for safer character comparison
                const typedChar = this.userInput.charAt(i);
                const expectedChar = this.textToType.charAt(i);

                if (typedChar === expectedChar) {
                  correctChars++;
                } else {
                  errorCount++;
                }
              } else {
                errorCount++;
              }
            }

            this.errors = errorCount;
            this.accuracy =
              this.userInput.length > 0
                ? Math.round((correctChars / this.userInput.length) * 100)
                : 100;
          },

          closeResults() {
            this.showResults = false;
            this.resetTest();
          },

          getPerformanceMessage() {
            const difficultyBonus = this.currentDifficulty === "hard" ? " on Hard mode" : 
                                   this.currentDifficulty === "easy" ? " on Easy mode" : "";
            
            if (this.finalWpm >= 80)
              return `Incredible! You're a typing master${difficultyBonus}!`;
            if (this.finalWpm >= 60) 
              return `Excellent typing speed${difficultyBonus}!`;
            if (this.finalWpm >= 40) 
              return `Good job${difficultyBonus}! Keep practicing!`;
            if (this.finalWpm >= 20)
              return `You're improving${difficultyBonus}! Practice makes perfect!`;
            return `Great start${difficultyBonus}! Keep practicing to improve!`;
          },


          loadStats() {
            const savedStats = localStorage.getItem('qwerty-stats');
            if (savedStats) {
              this.sessionStats = JSON.parse(savedStats);
            }
          },

          saveStats() {
            localStorage.setItem('qwerty-stats', JSON.stringify(this.sessionStats));
          },

          updateStats() {
            // Update session statistics
            this.sessionStats.testsCompleted++;
            
            // Update best WPM
            if (this.finalWpm > this.sessionStats.bestWpm) {
              this.sessionStats.bestWpm = this.finalWpm;
            }
            
            // Update average accuracy
            const totalAccuracy = this.sessionStats.totalAccuracy * (this.sessionStats.testsCompleted - 1) + this.finalAccuracy;
            this.sessionStats.totalAccuracy = Math.round(totalAccuracy / this.sessionStats.testsCompleted);
            
            // Update time practiced (in minutes)
            this.sessionStats.timePracticed += Math.round((this.timeLimit - this.timeLeft) / 60 * 10) / 10;
            
            // Save to localStorage
            this.saveStats();
          },

          toggleFocusMode() {
            this.focusMode = !this.focusMode;
            // Hide/show UI elements for distraction-free typing
            console.log('Focus mode', this.focusMode ? 'enabled' : 'disabled');
          },

          exportResults() {
            // Create a simple text export of the last test results
            const results = `QWERTY Typing Test Results
Date: ${new Date().toLocaleDateString()}
Time: ${new Date().toLocaleTimeString()}
---
WPM: ${this.finalWpm}
Accuracy: ${this.finalAccuracy}%
Errors: ${this.finalErrors}
Characters Typed: ${this.totalChars}
Mode: ${this.currentMode}
Difficulty: ${this.currentDifficulty}
Time Limit: ${this.timeLimit}s
---
Generated by QWERTY Typing Test`;

            // Create and download the file
            const blob = new Blob([results], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `typing-test-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);
          },

          resetStats() {
            if (confirm('Are you sure you want to reset all statistics? This cannot be undone.')) {
              this.sessionStats = {
                testsCompleted: 0,
                bestWpm: 0,
                totalAccuracy: 0,
                timePracticed: 0
              };
              localStorage.removeItem('qwerty-stats');
              console.log('Statistics reset');
            }
          },
        };
      }
    </script>
  </body>
</html>
